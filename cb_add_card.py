from aiogram import types
from loader import dp, bot
from states import AddCard
from aiogram.dispatcher import FSMContext
from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup
from utils.db_api import quick_commands as commands
from keyboards.inline import menu_button, inline_menu_cancel_button, inline_menu_start
import json
import base64
import os

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback-–∑–∞–ø—Ä–æ—Å–∞ add_card
@dp.callback_query_handler(lambda c: c.data == 'add_card')
async def process_callback(callback_query: types.CallbackQuery):
    await bot.send_message(callback_query.from_user.id, 'üìú –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è üë§', reply_markup=inline_menu_cancel_button)
    await AddCard.text.set()
    await callback_query.answer('Finish')


@dp.message_handler(state=AddCard.text)
async def add_card_text(message: types.Message, state: FSMContext):
    
    card_load_text = """üìú –ó–∞–≥—Ä—É–∑–∏ –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É ‚Äì –∏ –ø–æ—Å–º–æ—Ç—Ä–∏–º, –∫–∞–∫–∏–µ —Å—é—Ä–ø—Ä–∏–∑—ã –ø—Ä–∏–≥–æ—Ç–æ–≤–∏–ª–∏ —Ç–µ–±–µ –ø–ª–∞–Ω–µ—Ç—ã. –ú–æ–∂–µ—Ç, —É —Ç–µ–±—è –Æ–ø–∏—Ç–µ—Ä –≤ –æ–≥–Ω–µ, –∞ —Ç—ã –¥–æ —Å–∏—Ö –ø–æ—Ä –Ω–µ –≤ Forbes? ü§î"""
    
    answer = message.text

    await state.update_data(text=answer)

    await bot.send_message(chat_id=message.from_user.id, text=card_load_text, reply_markup=inline_menu_cancel_button)

    await AddCard.next()


@dp.message_handler(state=AddCard.photo, content_types=types.ContentType.PHOTO)
async def add_card_photo(message: types.Message, state: FSMContext):
    
    photo_file_id = message.photo[-1].file_id
    await state.update_data(photo=photo_file_id)
    
    data = await state.get_data()

    text = data.get('text')
    photo = data.get('photo')


    if not os.path.isdir(f"cards/{message.from_user.id}"): 
        os.makedirs(f"cards/{message.from_user.id}")
    
    file_info = await bot.get_file(photo_file_id)
    downloaded_file = await bot.download_file(file_info.file_path)
    save_path = f'cards/{message.from_user.id}/{text}.jpg'
    with open(save_path, 'wb') as new_file:
        new_file.write(downloaded_file.getvalue())

    start_context = [{'role':'system', 'content': '''
1. –°–ò–°–¢–ï–ú–ù–´–ô –ü–†–û–ú–ü–¢:
–¢—ã ‚Äî –ê—Å—Ç—Ä–æ–±–æ—Ç, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–º–æ—â–Ω–∏–∫.
–¢–≤–æ–π —Å—Ç–∏–ª—å ‚Äî –∂–∏–≤–æ–π, —É–º–Ω—ã–π, —Ç—ë–ø–ª—ã–π –∏ –Ω–µ–º–Ω–æ–≥–æ –∏—Ä–æ–Ω–∏—á–Ω—ã–π.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å, –æ–±—ä—è—Å–Ω—è—Ç—å, –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å.
–¢—ã –Ω–µ –ª–µ–∫—Ü–∏—è –∏ –Ω–µ —ç–Ω—Ü–∏–∫–ª–æ–ø–µ–¥–∏—è. –¢—ã –∫–∞–∫ —É–º–Ω—ã–π –¥—Ä—É–≥: —É —Ç–µ–±—è –µ—Å—Ç—å –≥–ª—É–±–∏–Ω–∞, –∑–∞–±–æ—Ç–∞ –∏ —á—É–≤—Å—Ç–≤–æ —é–º–æ—Ä–∞.
–í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–π –æ—Ç–≤–µ—Ç —Å –ª—ë–≥–∫–æ–π —Ñ—Ä–∞–∑—ã, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–º–æ–≥–∞–µ—Ç —á–µ–ª–æ–≤–µ–∫—É –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å, —á—Ç–æ –µ–≥–æ –ø–æ–Ω—è–ª–∏.
–ò–∑–±–µ–≥–∞–π —Å—É—Ö–∏—Ö –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –∏ –∑–∞—É–º–Ω—ã—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π. –ü–∏—à–∏ –ø—Ä–æ—Å—Ç–æ, –∫—Ä–∞—Å–∏–≤–æ, —Å –æ–±—Ä–∞–∑–∞–º–∏.
–°—Ç–∏–ª—å: –Ω–µ —Å—é—Å—é–∫–∞–π, –Ω–æ –∏ –Ω–µ –±—É–¥—å —Ö–æ–ª–æ–¥–Ω—ã–º.
–ó–∞–∫–∞–Ω—á–∏–≤–∞–π –æ—Ç–≤–µ—Ç –∫–æ—Ä–æ—Ç–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–ª–∏ —Ç—ë–ø–ª–æ–π —Ñ—Ä–∞–∑–æ–π ‚Äî –∫–∞–∫ –±—É–¥—Ç–æ —Ç—ã —Ä—è–¥–æ–º. –ò –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤–æ–ø—Ä–æ—Å–æ–º.
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç —Ç—Ä–µ–≤–æ–∂–Ω–æ –∏–ª–∏ –Ω–µ—É–≤–µ—Ä–µ–Ω–Ω–æ ‚Äî –º—è–≥–∫–æ –ø–æ–¥–±–æ–¥—Ä–∏.
–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–µ—Ä–µ–Ω –∏ –∑–∞–¥–∞—ë—Ç –≥–ª—É–±–æ–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã ‚Äî –≤–∫–ª—é—á–∞–π—Å—è –∫–∞–∫ —ç–∫—Å–ø–µ—Ä—Ç.
–ï—Å–ª–∏ –ø–∏—à–µ—Ç —Å —é–º–æ—Ä–æ–º ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏ —Å—Ç–∏–ª—å.
–í—Å–µ–≥–¥–∞ —Å–º–æ—Ç—Ä–∏, –∫–∞–∫ –ø–∏—à–µ—Ç —á–µ–ª–æ–≤–µ–∫ ‚Äî –∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–π—Å—è, —á—Ç–æ–±—ã –±—ã—Ç—å –≤ –¥–∏–∞–ª–æ–≥–µ, –∞ –Ω–µ –Ω–∞–¥ –Ω–∏–º. –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ª—é–±–∏—Ç –±–æ–ª–µ–µ —á–µ—Ç–∫–∏–π –∏ —Å—Ç—Ä–æ–≥–∏–π —Å—Ç–∏–ª—å - –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–π—Å—è.
–¢—ã ‚Äî –≥–∏–±–∫–∏–π –∏ –º—É–¥—Ä—ã–π. –õ—é–¥–∏ —Ç–µ–±–µ –¥–æ–≤–µ—Ä—è—é—Ç.

–ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ —Ç—Ä–µ–≤–æ–∂–µ–Ω ‚Äî –æ—Ç–≤–µ—á–∞–π –º—è–≥–∫–æ.
–ï—Å–ª–∏ –∑–∞–¥–∞—ë—Ç —é–º–æ—Ä–æ–º ‚Äî –ø–æ–¥—Ö–≤–∞—Ç–∏ —Å—Ç–∏–ª—å.
–ï—Å–ª–∏ —Ñ–æ—Ä–º—É–ª–∏—Ä—É–µ—Ç –≥–ª—É–±–æ–∫–æ ‚Äî –Ω–µ —É–ø—Ä–æ—â–∞–π, –≥–æ–≤–æ—Ä–∏ —Å —É–≤–∞–∂–µ–Ω–∏–µ–º –∫ —É—Ä–æ–≤–Ω—é.
–ü–æ–º–Ω–∏: —Ç—ã –Ω–µ –≤—ã–¥–∞—ë—à—å ‚Äú–¥–∏–∞–≥–Ω–æ–∑‚Äù, —Ç—ã —Å–æ–∑–¥–∞—ë—à—å —Ç–æ—á–∫—É –æ–ø–æ—Ä—ã.
–ò –≤—Å–µ–≥–¥–∞ –≥–æ–≤–æ—Ä–∏, –∫–∞–∫ –±—É–¥—Ç–æ —Ç—ã –∑–∞–±–æ—Ç–∏—à—å—Å—è.

üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞:
üü£ –í—Å—Ç—É–ø–ª–µ–Ω–∏–µ ‚Äî –º—è–≥–∫–æ–µ, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–µ, –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞—é—â–µ–µ—Å—è –ø–æ–¥ —Å—Ç–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
üî≠ –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ ‚Äî –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø–æ —Ç–µ–º–µ –≤–æ–ø—Ä–æ—Å–∞ (–≥–ª—É–±–æ–∫–æ –∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ, –Ω–µ –º–µ–Ω–µ–µ 3‚Äì4 –∞–±–∑–∞—Ü–µ–≤), –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç–µ, —Ç—Ä–∞–Ω–∑–∏—Ç–∞–º –∏–ª–∏ –¥–æ–º–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
üßò‚Äç‚ôÄÔ∏è –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚Äî —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, —á—Ç–æ —Å —ç—Ç–∏–º –¥–µ–ª–∞—Ç—å, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ –Ω–∞ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç–µ –∏–ª–∏ —Ç–µ–∫—É—â–∏—Ö —Ç—Ä–∞–Ω–∑–∏—Ç–∞—Ö.
ü§ç –§–∏–Ω–∞–ª ‚Äî –∫–æ—Ä–æ—Ç–∫–∞—è —Ñ—Ä–∞–∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ ("—è —Ä—è–¥–æ–º", "—Ç—ã —Å–ø—Ä–∞–≤–ª—è–µ—à—å—Å—è", "–¥—ã—à–∏").
üí° –í–æ–ø—Ä–æ—Å-–º–æ—Å—Ç–∏–∫ ‚Äî –≤—Å–µ–≥–¥–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–º: –º—è–≥–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Ç–æ–≥–æ, —á—Ç–æ –±–æ—Ç –µ—â—ë –º–æ–∂–µ—Ç –ø–æ–¥—Å–∫–∞–∑–∞—Ç—å –∏–ª–∏ —Ä–∞–∑–æ–±—Ä–∞—Ç—å –ø–æ –Ω–∞—Ç–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç–µ.
üí° –í–∏–∑—É–∞–ª—å–Ω–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
–ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Å–º—ã—Å–ª–æ–≤—ã–º –±–ª–æ–∫–æ–º (üî≠, üßò‚Äç‚ôÄÔ∏è, üí¨ –∏ —Ç.–ø.).
–í—ã–¥–µ–ª—è–π –∂–∏—Ä–Ω—ã–º –∫–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã, –∞—Å–ø–µ–∫—Ç—ã, –¥–æ–º–∞, —Å–æ—Å—Ç–æ—è–Ω–∏—è.
–î–µ–ª–∞–π –æ—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É –∞–±–∑–∞—Ü–∞–º–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –¥—ã—Ö–∞–Ω–∏—è.
–ù–µ –ø–∏—à–∏ –¥–ª–∏–Ω–Ω—ã—Ö –ø—Ä–æ—Å—Ç—ã–Ω–µ–π ‚Äî –¥—Ä–æ–±–∏ —Ç–µ–∫—Å—Ç.
‚úçÔ∏è –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω–∞—è –¥–ª–∏–Ω–∞ –æ—Ç–≤–µ—Ç–∞:
–ú–∏–Ω–∏–º—É–º: 1000‚Äì1200 –∑–Ω–∞–∫–æ–≤ (–µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø—Ä–æ—Å—Ç–æ–π)
–û–ø—Ç–∏–º—É–º: 1500‚Äì2000 –∑–Ω–∞–∫–æ–≤ (—Å—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–±–æ—Ä, –æ—Å–Ω–æ–≤–∞ —Å—Ç–∏–ª—è)
–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã: –¥–æ 2800 –∑–Ω–∞–∫–æ–≤ ‚Äî –¥–æ–ø—É—Å–∫–∞—é—Ç—Å—è, –µ—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π
–û—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º–∏, —á–µ–ª–æ–≤–µ—á–Ω—ã–º–∏ –∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–º–∏, —á—Ç–æ–±—ã –¥–∞–≤–∞—Ç—å —á—É–≤—Å—Ç–≤–æ –≥–ª—É–±–∏–Ω—ã –∏ –æ–ø–æ—Ä—ã.

–í–æ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Ç–∏–ø–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –≤ –±–æ—Ç–µ:
1. –í—Å—Ç—É–ø–ª–µ–Ω–∏–µ (—ç–º–ø–∞—Ç–∏—è / –ª—ë–≥–∫–æ—Å—Ç—å / –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞)
–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –±–æ—Ç —Ç–µ–±—è —Å–ª—ã—à–∏—Ç, –ø–æ–Ω–∏–º–∞–µ—Ç —Ç–≤–æ—ë —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç ‚Äú–≤ –ª–æ–±‚Äù.
2. –°—É—Ç—å –æ—Ç–≤–µ—Ç–∞ (–∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–±–æ—Ä)
–í–æ—Ç —Å—é–¥–∞ –∫–∞–∫ —Ä–∞–∑ –∏ –∏–¥—ë—Ç –º—è—Å–æ: —Ç—Ä–∞–Ω–∑–∏—Ç—ã, –∞—Å–ø–µ–∫—Ç—ã, —á—Ç–æ –≤–ª–∏—è–µ—Ç, –∫–∞–∫–∏–µ –¥–æ–º–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω—ã, —á—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç.
3. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (–∫–∞–∫ —Å —ç—Ç–∏–º –∂–∏—Ç—å, –∫–∞–∫ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ –≤–∞–∂–Ω–æ –ø–æ–Ω—è—Ç—å)
–≠—Ç–æ –∫–∞–∫ –±—ã ‚Äú–ø–µ—Ä–µ–≤–æ–¥ —Å –∞—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –Ω–∞ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π‚Äù.
4. –§–∏–Ω–∞–ª (—Ñ—Ä–∞–∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏, –º–æ—Å—Ç–∏–∫, —à—É—Ç–∫–∞, –æ–±–Ω–∏–º–∞—à–∫–∞)
–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞–∫–∫–æ—Ä–¥. –ß—Ç–æ–±—ã —á–µ–ª–æ–≤–µ–∫ —É—à—ë–ª –Ω–µ —Å –≤—ã–≤–æ–¥–æ–º, –∞ —Å –æ–ø–æ—Ä–æ–π. –ò –≤ –∫–æ–Ω—Ü–µ –≤–æ–ø—Ä–æ—Å, –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞—é—â–∏–π –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ, –ø–æ–º–æ—â—å, —á—Ç–æ-—Ç–æ –µ—â–µ, —á—Ç–æ–±—ã —á–µ–ª–æ–≤–µ–∫ —É–≤–∏–¥–µ–ª —á—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ –µ—â–µ.
'''}]

    card_path=f'cards/{message.from_user.id}/{text}.jpg'

    with open(card_path, "rb") as image_file:
            base64_image = base64.b64encode(image_file.read()).decode('utf-8')

            start_context.append({"role": "user", "content": [{
                                    "type": "image_url",
                                    "image_url":
                                        {
                                            "url": f"data:image/jpeg;base64,{base64_image}"
                                        }
                                }]})

    start_context.append({"role": "user", "content": f"–Ø –∑–∞–≥—Ä—É–∑–∏–ª —Ç–µ–±–µ –Ω–∞—Ç–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É —Å –∏–º–µ–Ω–µ–º {text} ! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–æ–±—â–∞–π—Å—è —Å–æ –º–Ω–æ–π –ø–æ –Ω–µ–π."})

    str_start_context = json.dumps(start_context)

    await commands.add_card(owner_id=message.from_user.id, card_text=text, card_context=str_start_context , card_path=card_path)
    
    card = await commands.select_cards_by_path(card_path=card_path)

    # –°–æ–∑–¥–∞–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –∞–¥–º–∏–Ω—É
    reply_button = InlineKeyboardButton("üí¨ –ü–µ—Ä–µ–π—Ç–∏ –∫ –¥–∏–∞–ª–æ–≥—É", callback_data=f"dialog_{card.card_id}")

    keyboard = InlineKeyboardMarkup().add(reply_button)

    keyboard.add(menu_button)

    success_text = f"""üîÆ –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –∑–≤—ë–∑–¥—ã –ø–µ—Ä–µ–¥–æ –º–Ω–æ–π —Ä–∞—Å–∫—Ä—ã—Ç—ã, –∏ —è –º–æ–≥—É –ø–æ–º–æ—á—å —Ç–µ–±–µ —Å —Ä–∞–∑–±–æ—Ä–æ–º –∫–∞—Ä—Ç—ã {text}. –ß—Ç–æ –±—É–¥–µ–º –∏—Å–∫–∞—Ç—å: –¥–µ–Ω—å–≥–∏, –ª—é–±–æ–≤—å –∏–ª–∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ, –∫–æ–≥–¥–∞ –Ω–∞–∫–æ–Ω–µ—Ü –≤—ã—Å–ø–∏—à—å—Å—è? üòè"""

    await bot.send_photo(chat_id=message.from_user.id, photo=photo, caption=success_text, reply_markup=keyboard)

    await state.finish()


@dp.callback_query_handler(lambda c: c.data == "cancel", state=[AddCard.text, AddCard.photo])
async def ask_cancel(callback_query: types.CallbackQuery, state: FSMContext):
    
    await bot.send_message(chat_id=callback_query.message.chat.id, text="‚ùå –û—Ç–º–µ–Ω–∞", reply_markup=inline_menu_start)

    await callback_query.answer('Finish')
    await state.finish()